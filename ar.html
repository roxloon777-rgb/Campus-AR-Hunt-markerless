<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Treasure Hunt</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    button {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 10px 20px;
      font-size: 18px;
    }
    #takeSelfie { bottom: 20px; }
    #uploadPadlet { bottom: 70px; display:none; }
  </style>
</head>
<body>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  renderer="antialias: true; alpha: true; physicallyCorrectLights: true"
>
  <a-entity light="type: ambient; color: #ffffff; intensity: 0.6"></a-entity>
  <a-entity light="type: directional; intensity: 0.8" position="1 3 2"></a-entity>

  <a-camera id="camera" position="0 1.6 0"></a-camera>
</a-scene>

<button id="takeSelfie">Take Selfie</button>
<button id="uploadPadlet">Upload to Padlet</button>

<script>
  // Treasure hunt locations
  const objects = [
    {id:'law', lat: -26.689666, lon: 27.092627, model:"assets/models/medical_mask.glb"},
    {id:'lovers', lat: -26.687913, lon: 27.092682, model:"assets/models/medical_syringe.glb"},
    {id:'tree', lat: -26.688911, lon: 27.092593, model:"assets/models/doctors_stethoscope.glb"}
  ];

  const SHOW_DISTANCE = 80; // meters
  const collected = JSON.parse(localStorage.getItem('collected') || '{}');
  let lastSelfieData = null;
  let lastCollectedObject = null;

  function getDistance(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    const R = 6371e3;
    const φ1 = toRad(lat1);
    const φ2 = toRad(lat2);
    const Δφ = toRad(lat2 - lat1);
    const Δλ = toRad(lon2 - lon1);
    const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Watch GPS
  navigator.geolocation.watchPosition(pos => {
    const userLat = pos.coords.latitude;
    const userLon = pos.coords.longitude;

    objects.forEach(obj => {
      const distance = getDistance(userLat, userLon, obj.lat, obj.lon);

      if(distance <= SHOW_DISTANCE && !collected[obj.id]) {
        // Mark as collected
        collected[obj.id] = true;
        localStorage.setItem('collected', JSON.stringify(collected));
        alert(`You have collected: ${obj.id.toUpperCase()}!`);

        // Spawn the model + ground plane in front of the user
        const scene = document.querySelector('a-scene');

        const container = document.createElement('a-entity');
        container.setAttribute('position', '0 0 -3'); // 3m in front of user

        // 3D model
        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', obj.model);
        model.setAttribute('scale', '0.5 0.5 0.5'); // safe size
        model.setAttribute('rotation', '0 180 0');
        container.appendChild(model);

        // Ground circle / shadow
        const ground = document.createElement('a-circle');
        ground.setAttribute('radius', '1.2');
        ground.setAttribute('rotation', '-90 0 0');
        ground.setAttribute('position', '0 0 0');
        ground.setAttribute('material', 'color: #000000; opacity: 0.25; side: double');
        container.appendChild(ground);

        scene.appendChild(container);

        lastCollectedObject = obj.id;
      }
    });
  }, err => console.error(err), { enableHighAccuracy: true });

  // Take selfie
  document.getElementById('takeSelfie').addEventListener('click', () => {
    if(!lastCollectedObject) {
      alert('Move closer to an object to take a selfie!');
      return;
    }
    const scene = document.querySelector('a-scene');
    scene.components.screenshot.capture('perspective', (dataUri) => {
      lastSelfieData = dataUri;
      document.getElementById('uploadPadlet').style.display = 'block';
      window.open(dataUri); // open selfie in new tab
    });
  });

  // Upload to Padlet
  document.getElementById('uploadPadlet').addEventListener('click', () => {
    if(!lastSelfieData) {
      alert('Take a selfie first!');
      return;
    }
    window.open('https://padlet.com/roxloon777/campus-hunt-wall-of-fame-gkek97r08b9p9047', '_blank');
    alert('Drag your selfie from the opened tab onto the Padlet wall.');
  });
</script>

</body>
</html>
